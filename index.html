<script>
const SUPABASE_URL = "https://robjczsumjidmhfsacua.supabase.co";
const SUPABASE_ANON_KEY = "TU_ANON_KEY";

const app = document.getElementById("app");
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  app.classList.add("error");
  app.innerHTML = "<h1>❌ Error</h1><p>ID no proporcionado</p>";
  throw new Error("ID no proporcionado");
}

fetch(`${SUPABASE_URL}/rest/v1/asociados?id=eq.${id}`, {
  headers: {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`
  }
})
.then(r => r.json())
.then(data => {
  if (!data.length) {
    app.classList.remove("ok");
    app.classList.add("error");
    app.innerHTML = "<h1>❌ NO VÁLIDO</h1><p>Asociado no encontrado</p>";
    return;
  }

  const a = data[0];
  app.classList.remove("error");
  app.classList.add("ok");

  app.innerHTML = `
    <h1>✅ CREDENCIAL VÁLIDA</h1>

    <div class="foto-container">
      <img id="fotoAsociado" alt="Foto del asociado">
    </div>

    <div class="label">Nombre</div>
    <div class="value">${a.nombres} ${a.apellidos}</div>

    <div class="label">CI</div>
    <div class="value">${a.ci}</div>

    <div class="label">Grado</div>
    <div class="value">${a.grado}</div>

    <div class="label">Fuerza</div>
    <div class="value">${a.fuerza}</div>

    <div class="label">Estado</div>
    <div class="value">${a.estado}</div>

    <div class="label">Vigencia</div>
    <div class="value">${a.vigencia}</div>

    <div class="footer">
      Asociación Boliviana de Ingenieros Militares<br>
      Verificación QR oficial
    </div>
  `;

  const foto = document.getElementById("fotoAsociado");
  if (foto && a.foto_asociado_url && a.foto_asociado_url.startsWith("http")) {
    foto.src = a.foto_asociado_url;
  } else if (foto) {
    foto.style.display = "none";
  }
})
.catch(err => {
  console.error(err);
  app.classList.add("error");
  app.innerHTML = "<h1>❌ Error del sistema</h1><p>No se pudo verificar la credencial</p>";
});
</script>
