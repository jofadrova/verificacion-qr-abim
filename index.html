<script>
const SUPABASE_URL = "https://robjczsumjidmhfsacua.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvYmpjenN1bWppZG1oZnNhY3VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI3MjEsImV4cCI6MjA4NTc5ODcyMX0.IfU2olTfkQ2KrepGomFX_-GTL6s_YLMRDwgNh_wpMVg";

const app = document.getElementById("app");
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  app.classList.add("error");
  app.innerHTML = "<h1>❌ Error</h1><p>ID no proporcionado</p>";
  throw new Error("ID no proporcionado");
}

fetch(`${SUPABASE_URL}/rest/v1/asociados?id=eq.${id}`, {
  headers: {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`
  }
})
.then(r => r.json())
.then(data => {
  if (!data.length) {
    app.classList.add("error");
    app.innerHTML = "<h1>❌ NO VÁLIDO</h1><p>Asociado no encontrado</p>";
    return;
  }

  const a = data[0];
  app.classList.add("ok");

  app.innerHTML = `
    <h1>✅ CREDENCIAL VÁLIDA</h1>

    <div class="foto-container">
      <img id="fotoAsociado" alt="Foto del asociado">
    </div>

    <div class="label">Nombre</div>
    <div class="value">${a.nombres} ${a.apellidos}</div>

    <div class="label">CI</div>
    <div class="value">${a.ci}</div>

    <div class="label">Grado</div>
    <div class="value">${a.grado}</div>

    <div class="label">Fuerza</div>
    <div class="value">${a.fuerza}</div>

    <div class="label">Estado</div>
    <div class="value">${a.estado}</div>

    <div class="label">Vigencia</div>
    <div class="value">${a.vigencia}</div>

    <div class="footer">
      Asociación Boliviana de Ingenieros Militares<br>
      Verificación QR oficial
    </div>
  `;

  const foto = document.getElementById("fotoAsociado");
  if (foto && a.foto_asociado_url) {
    foto.src = a.foto_asociado_url;
  }
})
.catch(err => {
  console.error(err);
  app.classList.add("error");
  app.innerHTML = "<h1>❌ Error del sistema</h1>";
});
</script>

